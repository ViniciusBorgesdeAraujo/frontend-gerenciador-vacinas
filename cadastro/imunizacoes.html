<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Página de Imunizações</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Ícones FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
  </head>
  <body>
    <div id="menu">
      <!-- menu.html -->
      <header class="header_area">
        <nav class="navbar navbar-expand-lg navbar-light">
          <div class="container">
            <a class="navbar-brand logo_h" href="../index.html">
              <img src="../img/logo.png" alt="Logo" />
            </a>
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="nav navbar-nav ms-auto">
                <li class="nav-item">
                  <a class="nav-link" href="../index.html">Início</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../cadastro/vacina.html">Vacinas</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../cadastro/paciente.html">Cadastro</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../cadastro/imunizacoes.html">Imunizações</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../cadastro/estatisticas.html">Estatisticas</a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </header>
    </div>

    <section class="banner_area">
      <div class="banner_inner d-flex align-items-center">
        <div class="container">
          <div
            class="banner_content d-md-flex justify-content-between align-items-center"
          >
            <div class="mb-3 mb-md-0">
              <h2>Informações</h2>
              <p>de Imunizações</p>
            </div>
            <div class="search-bar">
              <!-- Barra de busca por ID do Paciente -->
              <div class="d-flex mb-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Buscar por ID do Paciente"
                  id="search-id"
                />
                <button class="btn btn-primary ms-2" id="search-id-btn">
                  Buscar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabela de Imunizações -->
<section class="container mt-4">

  <a href="../cadastro/adicionar/imunizacao.html" class="main_btn mb-4 "
        >Adicionar Imunização</a>

  <h3>Lista de Imunizações</h3>
  <table class="table table-striped table-bordered">
    <thead class="bg-light">
      <tr>
        <th>ID</th>
        <th>Nome Paciente</th>
        <th>Vacina</th>
        <th>Dose</th>
        <th>Data de Aplicação</th>
        <th>Fabricante</th>
        <th>Lote</th>
        <th>Local</th>
        <th>Profissional</th>
      </tr>
    </thead>
    <tbody id="tabela-imunizacoes">
      <!-- Dados das imunizações serão carregados aqui -->
    </tbody>
  </table>
</section>

    <!-- JavaScript externo -->
    <script src="/js/include.js"></script>
    <script type="module" src="../js/imunizacoes.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal para excluir imunização -->
<div id="modalExcluir" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Excluir Imunização</h5>
        <button type="button" class="main_btn" onclick="fecharModalExcluir()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h5>Confirma a exclusão da imunização?</h5>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="main_btn"
          id="botaoConfirmarExcluir"
          onclick="excluirImunizacao(this)"
        >
          Sim
        </button>
        <button
          type="button"
          class="main_btn_light"
          onclick="fecharModalExcluir()"
        >
          Não
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para exibir mensagem para o usuário -->
<div id="modalMensagem" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mensagemTitulo"></h5>
        <button type="button" class="close" onclick="fecharModalMensagem()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h4 id="mensagemStatus"></h4>
      </div>
      <div class="modal-footer">
        <button type="button" class="main_btn" onclick="fecharModalMensagem()">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Função para abrir o modal de exclusão
function abrirModalExcluir(id) {
  const botaoConfirmarExcluir = document.getElementById("botaoConfirmarExcluir");
  botaoConfirmarExcluir.setAttribute("data-id", id); // Passa o ID para o botão de confirmação

  const modalExcluir = document.getElementById("modalExcluir");
  modalExcluir.style.display = "block"; // Exibe o modal
}

// Função para fechar o modal de exclusão
function fecharModalExcluir() {
  const modalExcluir = document.getElementById("modalExcluir");
  modalExcluir.style.display = "none"; // Oculta o modal
}

// Função para excluir a imunização
async function excluirImunizacao(botao) {
  let mensagem;

  try {
    // Obtém o ID da imunização a ser excluída
    const id = botao.getAttribute("data-id");

    // Realiza a chamada da API para excluir a imunização
    const response = await fetch(`http://localhost:3000/imunizacao/excluir/${id}`, {
      method: "DELETE",
    });

    // Verifica se a resposta da API foi bem-sucedida
    if (!response.ok) {
      const codigoStatus = determinarCodigoStatus(response);
      mensagem = retornarMensagem(codigoStatus);
    } else {
      mensagem = "Imunização excluída com sucesso!";
    }
  } catch (error) {
    mensagem = "Erro ao excluir imunização: " + error.message;
  }

  // Fecha o modal de exclusão
  fecharModalExcluir();

  location.reload()
  
  // Exibe o modal de mensagem com o resultado da exclusão
  abrirModalMensagem("Exclusão de Imunização", mensagem);

  // Recarrega a lista de imunizações após a exclusão
  carregarImunizacoes();
}

// Função para carregar as imunizações
async function carregarImunizacoes() {
  try {
    // Faz a chamada na API para buscar as imunizações
    const response = await fetch("http://localhost:3000/imunizacao/consultar");

    if (!response.ok) {
      const codigoStatus = determinarCodigoStatus(response);
      const mensagem = retornarMensagem(codigoStatus);
      abrirModalMensagem("Consultar Imunizações", mensagem);
      return;
    }

    // Converte os dados de JSON para objeto JavaScript
    const imunizacoes = await response.json();

    // Atualiza a tabela com os dados das imunizações
    atualizarTabela(imunizacoes);
  } catch (error) {
    abrirModalMensagem("Consultar Imunizações", "Erro: " + error.message);
  }
}

// Função para atualizar a tabela de imunizações


// Carrega as imunizações ao carregar a página
document.addEventListener("DOMContentLoaded", function () {
  carregarImunizacoes();
});
</script>
  </body>
</html>